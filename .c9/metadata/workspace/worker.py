{"filter":false,"title":"worker.py","tooltip":"/worker.py","undoManager":{"mark":100,"position":100,"stack":[[{"start":{"row":1026,"column":20},"end":{"row":1026,"column":21},"action":"insert","lines":["R"],"id":635}],[{"start":{"row":1026,"column":21},"end":{"row":1026,"column":22},"action":"insert","lines":["e"],"id":636}],[{"start":{"row":1026,"column":22},"end":{"row":1026,"column":23},"action":"insert","lines":["c"],"id":637}],[{"start":{"row":1026,"column":23},"end":{"row":1026,"column":24},"action":"insert","lines":["o"],"id":638}],[{"start":{"row":1026,"column":24},"end":{"row":1026,"column":25},"action":"insert","lines":["r"],"id":639}],[{"start":{"row":1026,"column":25},"end":{"row":1026,"column":26},"action":"insert","lines":["d"],"id":640}],[{"start":{"row":1033,"column":12},"end":{"row":1033,"column":15},"action":"remove","lines":["rec"],"id":641},{"start":{"row":1033,"column":12},"end":{"row":1033,"column":26},"action":"insert","lines":["reportDbRecord"]}],[{"start":{"row":1026,"column":0},"end":{"row":1033,"column":32},"action":"remove","lines":["            reportDbRecord = Report(","                name=zoneTitle + \" \" + zoneSubTitle,","                key_name=zoneKey,","                zoneKey=zoneKey,","                report=zd.to_JSON()","            )","","            reportDbRecord.put()"],"id":642}],[{"start":{"row":909,"column":0},"end":{"row":912,"column":0},"action":"remove","lines":["","            #print calendar.timegm(time.gmtime())","            #print self.request.get('timestamp')",""],"id":643},{"start":{"row":909,"column":0},"end":{"row":910,"column":0},"action":"insert","lines":["",""]}],[{"start":{"row":910,"column":0},"end":{"row":911,"column":0},"action":"insert","lines":["",""],"id":644}],[{"start":{"row":911,"column":0},"end":{"row":912,"column":0},"action":"insert","lines":["",""],"id":645}],[{"start":{"row":912,"column":0},"end":{"row":913,"column":0},"action":"insert","lines":["",""],"id":646}],[{"start":{"row":912,"column":0},"end":{"row":913,"column":0},"action":"remove","lines":["",""],"id":647}],[{"start":{"row":911,"column":0},"end":{"row":912,"column":0},"action":"remove","lines":["",""],"id":648}],[{"start":{"row":910,"column":0},"end":{"row":911,"column":0},"action":"remove","lines":["",""],"id":649}],[{"start":{"row":909,"column":0},"end":{"row":910,"column":0},"action":"remove","lines":["",""],"id":650}],[{"start":{"row":908,"column":54},"end":{"row":909,"column":0},"action":"remove","lines":["",""],"id":651}],[{"start":{"row":912,"column":0},"end":{"row":913,"column":0},"action":"insert","lines":["",""],"id":652}],[{"start":{"row":913,"column":0},"end":{"row":914,"column":0},"action":"insert","lines":["",""],"id":653}],[{"start":{"row":914,"column":0},"end":{"row":915,"column":0},"action":"insert","lines":["",""],"id":654}],[{"start":{"row":915,"column":0},"end":{"row":916,"column":0},"action":"insert","lines":["",""],"id":655}],[{"start":{"row":914,"column":0},"end":{"row":915,"column":0},"action":"insert","lines":["",""],"id":656}],[{"start":{"row":915,"column":0},"end":{"row":916,"column":0},"action":"insert","lines":["",""],"id":657}],[{"start":{"row":916,"column":0},"end":{"row":917,"column":0},"action":"insert","lines":["",""],"id":658}],[{"start":{"row":917,"column":0},"end":{"row":918,"column":0},"action":"insert","lines":["",""],"id":659}],[{"start":{"row":914,"column":0},"end":{"row":914,"column":4},"action":"insert","lines":["    "],"id":660}],[{"start":{"row":914,"column":4},"end":{"row":914,"column":8},"action":"insert","lines":["    "],"id":661}],[{"start":{"row":914,"column":8},"end":{"row":914,"column":12},"action":"insert","lines":["    "],"id":662}],[{"start":{"row":914,"column":12},"end":{"row":914,"column":13},"action":"insert","lines":["#"],"id":663}],[{"start":{"row":914,"column":13},"end":{"row":914,"column":14},"action":"insert","lines":[" "],"id":664}],[{"start":{"row":914,"column":14},"end":{"row":914,"column":15},"action":"insert","lines":["F"],"id":665}],[{"start":{"row":914,"column":15},"end":{"row":914,"column":16},"action":"insert","lines":["i"],"id":666}],[{"start":{"row":914,"column":16},"end":{"row":914,"column":17},"action":"insert","lines":["r"],"id":667}],[{"start":{"row":914,"column":17},"end":{"row":914,"column":18},"action":"insert","lines":["s"],"id":668}],[{"start":{"row":914,"column":18},"end":{"row":914,"column":19},"action":"insert","lines":["t"],"id":669}],[{"start":{"row":914,"column":19},"end":{"row":914,"column":20},"action":"insert","lines":["."],"id":670}],[{"start":{"row":914,"column":20},"end":{"row":914,"column":21},"action":"insert","lines":[" "],"id":671}],[{"start":{"row":914,"column":21},"end":{"row":914,"column":22},"action":"insert","lines":["C"],"id":672}],[{"start":{"row":914,"column":22},"end":{"row":914,"column":23},"action":"insert","lines":["r"],"id":673}],[{"start":{"row":914,"column":23},"end":{"row":914,"column":24},"action":"insert","lines":["e"],"id":674}],[{"start":{"row":914,"column":24},"end":{"row":914,"column":25},"action":"insert","lines":["a"],"id":675}],[{"start":{"row":914,"column":25},"end":{"row":914,"column":26},"action":"insert","lines":["t"],"id":676}],[{"start":{"row":914,"column":26},"end":{"row":914,"column":27},"action":"insert","lines":["e"],"id":677}],[{"start":{"row":914,"column":27},"end":{"row":914,"column":28},"action":"insert","lines":[" "],"id":678}],[{"start":{"row":914,"column":28},"end":{"row":914,"column":29},"action":"insert","lines":["t"],"id":679}],[{"start":{"row":914,"column":29},"end":{"row":914,"column":30},"action":"insert","lines":["h"],"id":680}],[{"start":{"row":914,"column":29},"end":{"row":914,"column":30},"action":"remove","lines":["h"],"id":681}],[{"start":{"row":914,"column":28},"end":{"row":914,"column":29},"action":"remove","lines":["t"],"id":682}],[{"start":{"row":914,"column":28},"end":{"row":914,"column":29},"action":"insert","lines":["o"],"id":683}],[{"start":{"row":914,"column":29},"end":{"row":914,"column":30},"action":"insert","lines":["r"],"id":684}],[{"start":{"row":914,"column":30},"end":{"row":914,"column":31},"action":"insert","lines":[" "],"id":685}],[{"start":{"row":914,"column":31},"end":{"row":914,"column":32},"action":"insert","lines":["u"],"id":686}],[{"start":{"row":914,"column":32},"end":{"row":914,"column":33},"action":"insert","lines":["p"],"id":687}],[{"start":{"row":914,"column":33},"end":{"row":914,"column":34},"action":"insert","lines":["d"],"id":688}],[{"start":{"row":914,"column":34},"end":{"row":914,"column":35},"action":"insert","lines":["a"],"id":689}],[{"start":{"row":914,"column":35},"end":{"row":914,"column":36},"action":"insert","lines":["t"],"id":690}],[{"start":{"row":914,"column":36},"end":{"row":914,"column":37},"action":"insert","lines":["e"],"id":691}],[{"start":{"row":914,"column":37},"end":{"row":914,"column":38},"action":"insert","lines":[" "],"id":692}],[{"start":{"row":914,"column":38},"end":{"row":914,"column":39},"action":"insert","lines":["t"],"id":693}],[{"start":{"row":914,"column":39},"end":{"row":914,"column":40},"action":"insert","lines":["h"],"id":694}],[{"start":{"row":914,"column":40},"end":{"row":914,"column":41},"action":"insert","lines":["e"],"id":695}],[{"start":{"row":914,"column":41},"end":{"row":914,"column":42},"action":"insert","lines":[" "],"id":696}],[{"start":{"row":914,"column":42},"end":{"row":914,"column":43},"action":"insert","lines":["r"],"id":697}],[{"start":{"row":914,"column":43},"end":{"row":914,"column":44},"action":"insert","lines":["e"],"id":698}],[{"start":{"row":914,"column":44},"end":{"row":914,"column":45},"action":"insert","lines":["c"],"id":699}],[{"start":{"row":914,"column":45},"end":{"row":914,"column":46},"action":"insert","lines":["o"],"id":700}],[{"start":{"row":914,"column":46},"end":{"row":914,"column":47},"action":"insert","lines":["r"],"id":701}],[{"start":{"row":914,"column":46},"end":{"row":914,"column":47},"action":"remove","lines":["r"],"id":702}],[{"start":{"row":914,"column":45},"end":{"row":914,"column":46},"action":"remove","lines":["o"],"id":703}],[{"start":{"row":914,"column":44},"end":{"row":914,"column":45},"action":"remove","lines":["c"],"id":704}],[{"start":{"row":914,"column":44},"end":{"row":914,"column":45},"action":"insert","lines":["p"],"id":705}],[{"start":{"row":914,"column":45},"end":{"row":914,"column":46},"action":"insert","lines":["o"],"id":706}],[{"start":{"row":914,"column":46},"end":{"row":914,"column":47},"action":"insert","lines":["r"],"id":707}],[{"start":{"row":914,"column":47},"end":{"row":914,"column":48},"action":"insert","lines":["t"],"id":708}],[{"start":{"row":914,"column":48},"end":{"row":914,"column":49},"action":"insert","lines":["."],"id":709}],[{"start":{"row":914,"column":49},"end":{"row":915,"column":0},"action":"insert","lines":["",""],"id":710},{"start":{"row":915,"column":0},"end":{"row":915,"column":12},"action":"insert","lines":["            "]}],[{"start":{"row":915,"column":12},"end":{"row":916,"column":0},"action":"insert","lines":["",""],"id":711},{"start":{"row":916,"column":0},"end":{"row":916,"column":12},"action":"insert","lines":["            "]}],[{"start":{"row":916,"column":0},"end":{"row":923,"column":32},"action":"insert","lines":["            reportDbRecord = Report(","                name=zoneTitle + \" \" + zoneSubTitle,","                key_name=zoneKey,","                zoneKey=zoneKey,","                report=zd.to_JSON()","            )","","            reportDbRecord.put()"],"id":712}],[{"start":{"row":950,"column":12},"end":{"row":950,"column":13},"action":"insert","lines":["#"],"id":713}],[{"start":{"row":950,"column":13},"end":{"row":950,"column":14},"action":"insert","lines":[" "],"id":714}],[{"start":{"row":956,"column":0},"end":{"row":1039,"column":0},"action":"remove","lines":["            \"\"\"","            Now, generate the report...","            1. Hitta ytterligare poster i samma zone","            2. Rakna ut medeltal for index och de olika gaserna.","            3. Kolla om det finns en rapport sedan tidigare.","            4. spara historiska data","            5. Berakna min24hr och max 24hr","            \"\"\"","","            \"\"\" Get the data newer than 1 hour \"\"\"","            #res = db.GqlQuery(\"SELECT * FROM Records WHERE zoneKey='\" + zoneKey + \"' AND timestamp >= :1\", datetime.datetime.now() - datetime.timedelta(hours = 6))","            res = db.GqlQuery(\"SELECT * FROM Records WHERE zoneKey='\" + zoneKey + \"'\")","","","            \"\"\" Create a list of all stations and history values \"\"\"","            avrIndex = 0","            stationsDict = {}","            historyDict = {}","            indexArr = []","            for r in res:","                historyDate = r.timestamp.strftime('%Y-%m-%d')","                indexArr = historyDict.get(historyDate, [0.0])","                indexArr.append(r.index)","                historyDict[historyDate] = indexArr","                avrIndex = avrIndex + r.index","                stationsDict[r.sourceId] = str(r.position)","","            stations = []","            for key, value in stationsDict.iteritems():","                temp = {}","                temp[\"sourceId\"] = key","                temp[\"position\"] = value","","                stations.append(temp)","","            \"\"\" Add a proper locale. For now all languages are english \"\"\"","            class Location(): pass","            location = Location()","            location.country=country.upper()","            location.language=\"en\"","","","            \"\"\" Create a array of history records. Each record contains the date and the index for that date.  \"\"\"","            historyArr = []","            class HistoricDate():","                def __init__(self, dict):","                    self.__dict__ = dict","","            for key, value in historyDict.iteritems():","                historyArr.append(HistoricDate({'date' : key, 'index':reduce(lambda x, y: x + y, value) / (len(value)-1)}))","","            \"\"\" Create the zone-detail object that will be persisted as a report for use in the zones API \"\"\"","            class ZoneDetail():","                def to_JSON(self):","                    return json.dumps(self, default=lambda o: o.__dict__, sort_keys=True)","","            zd = ZoneDetail()","            zd.zoneKey=zoneKey","            zd.title=zoneTitle","            zd.subtitle=zoneSubTitle","            zd.stations=stations","            try:","                zd.numberOfMeasurements=str(res.count())","                if res.count() > 0:","                    zd.index=avrIndex/res.count()","                else:","                    zd.index=float(res[0].index)","            except Exception, e:","            \tprint \"numberOfMeasurements and index set to 0\"","                zd.numberOfMeasurements = 0","                zd.index = 0","","            zd.co=co","            zd.no2=no2","            zd.pm10=pm10","            zd.pm25=pm25","            zd.o3=o3","            zd.location=location","            zd.position=position","            zd.history=historyArr","            zd.min24Hr=1.0","            zd.max24Hr=1.0","",""],"id":715}],[{"start":{"row":914,"column":0},"end":{"row":915,"column":12},"action":"remove","lines":["            # First. Create or update the report.","            "],"id":716}],[{"start":{"row":913,"column":0},"end":{"row":996,"column":0},"action":"insert","lines":["            \"\"\"","            Now, generate the report...","            1. Hitta ytterligare poster i samma zone","            2. Rakna ut medeltal for index och de olika gaserna.","            3. Kolla om det finns en rapport sedan tidigare.","            4. spara historiska data","            5. Berakna min24hr och max 24hr","            \"\"\"","","            \"\"\" Get the data newer than 1 hour \"\"\"","            #res = db.GqlQuery(\"SELECT * FROM Records WHERE zoneKey='\" + zoneKey + \"' AND timestamp >= :1\", datetime.datetime.now() - datetime.timedelta(hours = 6))","            res = db.GqlQuery(\"SELECT * FROM Records WHERE zoneKey='\" + zoneKey + \"'\")","","","            \"\"\" Create a list of all stations and history values \"\"\"","            avrIndex = 0","            stationsDict = {}","            historyDict = {}","            indexArr = []","            for r in res:","                historyDate = r.timestamp.strftime('%Y-%m-%d')","                indexArr = historyDict.get(historyDate, [0.0])","                indexArr.append(r.index)","                historyDict[historyDate] = indexArr","                avrIndex = avrIndex + r.index","                stationsDict[r.sourceId] = str(r.position)","","            stations = []","            for key, value in stationsDict.iteritems():","                temp = {}","                temp[\"sourceId\"] = key","                temp[\"position\"] = value","","                stations.append(temp)","","            \"\"\" Add a proper locale. For now all languages are english \"\"\"","            class Location(): pass","            location = Location()","            location.country=country.upper()","            location.language=\"en\"","","","            \"\"\" Create a array of history records. Each record contains the date and the index for that date.  \"\"\"","            historyArr = []","            class HistoricDate():","                def __init__(self, dict):","                    self.__dict__ = dict","","            for key, value in historyDict.iteritems():","                historyArr.append(HistoricDate({'date' : key, 'index':reduce(lambda x, y: x + y, value) / (len(value)-1)}))","","            \"\"\" Create the zone-detail object that will be persisted as a report for use in the zones API \"\"\"","            class ZoneDetail():","                def to_JSON(self):","                    return json.dumps(self, default=lambda o: o.__dict__, sort_keys=True)","","            zd = ZoneDetail()","            zd.zoneKey=zoneKey","            zd.title=zoneTitle","            zd.subtitle=zoneSubTitle","            zd.stations=stations","            try:","                zd.numberOfMeasurements=str(res.count())","                if res.count() > 0:","                    zd.index=avrIndex/res.count()","                else:","                    zd.index=float(res[0].index)","            except Exception, e:","            \tprint \"numberOfMeasurements and index set to 0\"","                zd.numberOfMeasurements = 0","                zd.index = 0","","            zd.co=co","            zd.no2=no2","            zd.pm10=pm10","            zd.pm25=pm25","            zd.o3=o3","            zd.location=location","            zd.position=position","            zd.history=historyArr","            zd.min24Hr=1.0","            zd.max24Hr=1.0","",""],"id":717}],[{"start":{"row":995,"column":0},"end":{"row":996,"column":0},"action":"remove","lines":["",""],"id":718}],[{"start":{"row":994,"column":26},"end":{"row":995,"column":0},"action":"remove","lines":["",""],"id":719}],[{"start":{"row":1007,"column":0},"end":{"row":1008,"column":0},"action":"remove","lines":["",""],"id":720}],[{"start":{"row":1006,"column":0},"end":{"row":1007,"column":0},"action":"remove","lines":["",""],"id":721}],[{"start":{"row":1005,"column":0},"end":{"row":1006,"column":0},"action":"remove","lines":["",""],"id":722}],[{"start":{"row":1004,"column":0},"end":{"row":1005,"column":0},"action":"remove","lines":["",""],"id":723}],[{"start":{"row":1006,"column":24},"end":{"row":1007,"column":0},"action":"insert","lines":["",""],"id":724},{"start":{"row":1007,"column":0},"end":{"row":1007,"column":16},"action":"insert","lines":["                "]}],[{"start":{"row":1007,"column":16},"end":{"row":1007,"column":17},"action":"insert","lines":["p"],"id":725}],[{"start":{"row":1007,"column":17},"end":{"row":1007,"column":18},"action":"insert","lines":["a"],"id":726}],[{"start":{"row":1007,"column":18},"end":{"row":1007,"column":19},"action":"insert","lines":["r"],"id":727}],[{"start":{"row":1007,"column":19},"end":{"row":1007,"column":20},"action":"insert","lines":["e"],"id":728}],[{"start":{"row":1007,"column":20},"end":{"row":1007,"column":21},"action":"insert","lines":["n"],"id":729}],[{"start":{"row":1007,"column":21},"end":{"row":1007,"column":22},"action":"insert","lines":["t"],"id":730}],[{"start":{"row":1007,"column":22},"end":{"row":1007,"column":23},"action":"insert","lines":[" "],"id":731}],[{"start":{"row":1007,"column":22},"end":{"row":1007,"column":23},"action":"remove","lines":[" "],"id":732}],[{"start":{"row":1007,"column":22},"end":{"row":1007,"column":23},"action":"insert","lines":["="],"id":733}],[{"start":{"row":1007,"column":23},"end":{"row":1007,"column":37},"action":"insert","lines":["reportDbRecord"],"id":734}],[{"start":{"row":1007,"column":37},"end":{"row":1007,"column":38},"action":"insert","lines":[","],"id":735}]]},"ace":{"folds":[],"scrolltop":18875,"scrollleft":0,"selection":{"start":{"row":1007,"column":38},"end":{"row":1007,"column":38},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":{"row":992,"state":"start","mode":"ace/mode/python"}},"timestamp":1486919505902,"hash":"490956922d0cc2f26ea644899c58913cb56b36ee"}